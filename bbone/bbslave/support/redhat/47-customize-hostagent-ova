#!/bin/sh
# Copyright (c) 2015 Platform9 Systems Inc.

# This script creates the hostagent OVA.
# It requires the vmware hostagent to already exist.


set -v
set -u
set -e
set -x

VERSION=__VERSION__
RELEASE=__BUILDNUM__.__GITHASH__
VERSION=${HOST_AGENT_VERSION:-${VERSION}}
RELEASE=${HOST_AGENT_RELEASE:-${RELEASE}}
MGMT_FQDN=${MGMT_FQDN:-${DU_FQDN}}

CURR_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ROOT_DIR=$CURR_DIR/../

PRIVATE_FILES_DIR=$ROOT_DIR/www/private
HOST_AGENT_VMW_RPM_SYMLINK=pf9-hostagent-vmw.x86_64.rpm
HOST_AGENT_VMW_RPM_PATH=${PRIVATE_FILES_DIR}/${HOST_AGENT_VMW_RPM_SYMLINK}

OVF_BASE_DIR=/opt/pf9/vmware
# Short name excludes extension
OVA_SHORT_NAME=platform9-vmware-appliance
OVA_NAME=${OVA_SHORT_NAME}-${VERSION}-${RELEASE}.ova
OVA_PATH=${PRIVATE_FILES_DIR}/${OVA_SHORT_NAME}-${VERSION}-${RELEASE}.ova
OVA_SYMLINK_NAME=${OVA_SHORT_NAME}.ova

ISO_NAME=hostagent.iso
ISO_PATH=${OVF_BASE_DIR}/${ISO_NAME}
ISO_STAGING_DIR=`mktemp -d`


cp ${HOST_AGENT_VMW_RPM_PATH} ${ISO_STAGING_DIR}
genisoimage -o ${ISO_PATH} -r ${ISO_STAGING_DIR}

pushd ${OVF_BASE_DIR}
tar -cvf ${OVA_SHORT_NAME}.ova \
         ${OVA_SHORT_NAME}{.ovf,-disk1.vmdk} \
         ${ISO_NAME}
popd

mv ${OVF_BASE_DIR}/${OVA_SHORT_NAME}.ova ${OVA_PATH}

pushd $PRIVATE_FILES_DIR
ln -sf $OVA_NAME $OVA_SYMLINK_NAME
popd

# Cleanup
rm -fr $OVF_BASE_DIR
rm -fr $ISO_STAGING_DIR

